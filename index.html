<!doctype html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Backsur - Roguelike Survival Game</title><style>body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      overflow: hidden;
      background-color: #000;
      color: white;
    }

    #game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }

    #ui-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
    }

    .fixed-panel {
      position: fixed;
      pointer-events: auto;
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid #fff;
      padding: 10px;
      border-radius: 5px;
      max-height: 600px;
      overflow-y: auto;
    }
    #game-stats {
      position: fixed;
      left:10px;
      top: 10px;
    }
    #player-info {
      top: 140px;
      left: 10px;
      max-height: 300px;
      overflow-y: auto;
    }

    #event-log {
      top: 470px;
      left: 10px;
      max-height: 300px;
      overflow-y: auto;
    }
     

    #dialogue-log {
      top: 10px;
      right: 10px;
      width: 300px;
      max-height: 600px;
      overflow-y: auto;
    }

    #survivor-details {
      top: 10px;
      left: 200px;
      width: 360px;
      max-height: 430px;
      overflow-y: auto;
    }

    #chat-interface {
      position: fixed;
      bottom: 120px;
      left: 10px;
      width: 400px;
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid #fff;
      border-radius: 5px;
      padding: 5px;
      display: none;
    }

    #ai-config {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 500px;
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid #fff;
      border-radius: 8px;
      padding: 20px;
      display: none;
      z-index: 2000;
    }

    .log-entry {
      margin-bottom: 5px;
      padding: 2px 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dialogue-entry {
      margin-bottom: 8px;
      padding: 5px;
      background: rgba(50, 50, 50, 0.5);
      border-radius: 3px;
    }

    .dialogue-speaker {
      font-weight: bold;
      color: #4dabf7;
      cursor: pointer;
      text-decoration: underline;
    }

    .controls {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      line-height: 1.4;
    }

    button {
      background: #4a6fa5;
      color: white;
      border: none;
      padding: 5px 10px;
      margin: 2px;
      border-radius: 3px;
      cursor: pointer;
      pointer-events: auto;
    }

    button:hover {
      background: #5a7fb5;
    }

    .hidden {
      display: none !important;
    }

    .survivor-item {
      margin-bottom: 8px;
      padding: 5px;
      background: rgba(50, 50, 50, 0.5);
      border-radius: 3px;
      overflow-x: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .survivor-name {
      display: inline-block;
      width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      vertical-align: middle;
    }

    

    #current-lang {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 5px 10px;
      border-radius: 3px;
      font-size: 14px;
      display: block;
    }

    #tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid #fff;
      border-radius: 3px;
      padding: 5px;
      font-size: 12px;
      pointer-events: none;
      z-index: 1000;
      white-space: nowrap;
      max-width: 300px;
      word-wrap: break-word;
    }
    
    .details-button {
      display: inline-block;
      background: #8a2be2;
      color: white;
      padding: 3px 6px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 11px;
      margin-left: 5px;
    }
    .jump-button {
      display: inline-block;
      background: #8a2be2;
      color: white;
      padding: 3px 6px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 11px;
      margin-left: 5px;
    }
    .chat-button {
      display: inline-block;
      background: #8a2be2;
      color: white;
      padding: 3px 6px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 11px;
      margin-left: 5px;
    }
    
    .ai-toggle {
      display: inline-block;
      background: #ff6b6b;
      color: white;
      padding: 3px 6px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 11px;
      margin-right: 5px;
    }
    
    .ai-toggle.enabled {
      background: #51cf66;
    }
    
    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      box-sizing: border-box;
      background: rgba(50, 50, 50, 0.8);
      color: white;
      border: 1px solid #fff;
      border-radius: 3px;
    }
    
    textarea {
      width: 100%;
      height: 100px;
      padding: 8px;
      margin: 5px 0;
      box-sizing: border-box;
      background: rgba(50, 50, 50, 0.8);
      color: white;
      border: 1px solid #fff;
      border-radius: 3px;
    }</style><script defer="defer" src="bundle.js"></script></head><body><div id="game-container"></div><div id="ui-overlay"><div id="player-info" class="fixed-panel"><h3>Player Status</h3><div id="status-content">Loading...</div></div><div id="game-stats" class="fixed-panel"></div><div id="event-log" class="fixed-panel"><h3>Event Log</h3><div id="log-content"></div><button id="clear-logs-btn">Clear Logs</button></div><div id="dialogue-log" class="fixed-panel"><h3>Dialogues</h3><div id="dialogue-content">No dialogues yet...</div><button id="toggle-dialogue-btn">Hide Dialogues</button></div><div id="survivor-details" class="fixed-panel"><h3>Survivors & Monsters</h3><div id="survivor-content">Loading...</div><button id="toggle-survivor-btn">Hide Details</button></div><div id="chat-interface" class="fixed-panel"><div id="chat-with" style="font-weight: bold;">Chatting with: <span id="chat-target">None</span></div><div id="chat-messages" style="height: 150px; overflow-y: auto; margin: 10px 0; padding: 5px; background: rgba(50, 50, 50, 0.5); border-radius: 3px;"></div><input id="chat-input" placeholder="Type your message here..."></div><div id="ai-config" class="fixed-panel"><h3>AI Configuration</h3><label for="api-url">API URL:</label> <input id="api-url" placeholder="https://api.openai.com/v1/chat/completions" value="https://api.deepseek.com/chat/completions"> <label for="api-key">API Key:</label><br/><input type="password" id="api-key" placeholder="Enter your API key"> <input id="api-model" placeholder="deepseek-chat" value="deepseek-chat"><div style="text-align: center; margin-top: 15px;"><button id="save-ai-config">Save Config</button> <button id="close-ai-config">Close</button></div></div><div class="controls"><p><strong>Controls:</strong></p><p>Arrow Keys: Move Player | WASD: Move Camera | X: Dismantle Near Material Wall to Collect Resources | R: Random Teleport | P: Spawn Person | K: Learn Knowledge | L: Toggle Logs | A: Attack Nearby Monster | Shift+Click: Set Path & Auto Move | Space: Pause | Some of these have a cooldown duration. Auto pick items on ground.<button onclick="window.open('./PLAY.md')">more about this game.</button></p><button id="open-ai-config">Configure AI</button> <span>the checkbox near the name toggle whether AI role play this person. click the chat button to talk to them.</span></div><button id="current-lang" onclick="document.querySelector('#current-lang').textContent = document.querySelector('#current-lang').textContent == 'EN' ? 'ZH': 'EN';">ZH</button></div><div id="tooltip" style="display: none;"></div><script>// 全局游戏状态变量
    let gameStats = document.getElementById('game-stats');
    let playerInfo = document.getElementById('player-info');
    let eventLog = document.getElementById('event-log');
    let tooltip = document.getElementById('tooltip');
    let currentLangElement = document.getElementById('current-lang');
    let survivorsPanel = document.getElementById('survivors-panel');
    let monstersPanel = document.getElementById('monsters-panel');
    let toggleSurvivorsBtn = document.getElementById('toggle-survivors-btn');
    let toggleMonstersBtn = document.getElementById('toggle-monsters-btn');
    let logsPanel = document.getElementById('logs-panel');
    let aiConfigPanel = document.getElementById('ai-config-panel');
    let tickRatePanel = document.getElementById('tick-rate-panel');
    
    // 更新游戏统计数据
    function updateGameStats(day, tick, alive, dead, monsters) {
      if (gameStats) {
        const lang = currentLangElement.textContent === 'zh' ? 'zh' : 'en';
        const labels = {
          zh: { day: '天数', tick: '滴答', alive: '存活', dead: '死亡', monsters: '怪物' },
          en: { day: 'Day', tick: 'Tick', alive: 'Alive', dead: 'Dead', monsters: 'Monsters' }
        };
        const l = labels[lang];
        
        gameStats.innerHTML = `
          ${l.day}: ${day}<br>
          ${l.tick}: ${tick}<br>
          ${l.alive}: ${alive}<br>
          ${l.dead}: ${dead}<br>
          ${l.monsters}: ${monsters}
        `;
      }
    }
    
    // 更新玩家信息
    function updatePlayerInfo(name, x, y, health, maxHealth, hunger, thirst, fatigue, attackPower, intelligence, inventory, knownKnowledges) {
      if (playerInfo) {
        const lang = currentLangElement.textContent === 'zh' ? 'zh' : 'en';
        const labels = {
          zh: { 
            health: '生命值', 
            hunger: '饥饿度', 
            thirst: '口渴度', 
            fatigue: '疲劳度', 
            attackPower: '攻击力',
            intelligence: '智力',
            inventory: '库存',
            knowledge: '知识',
            drop: '丢弃'
          },
          en: { 
            health: 'Health', 
            hunger: 'Hunger', 
            thirst: 'Thirst', 
            fatigue: 'Fatigue', 
            attackPower: 'Attack Power',
            intelligence: 'Intelligence',
            inventory: 'Inventory',
            knowledge: 'Knowledge',
            drop: 'Drop'
          }
        };
        const l = labels[lang];
        
        // 首先更新基本状态信息
        const playerInfoDiv = document.getElementById('player-info');
        if (!playerInfoDiv) return;
        
        // 获取或创建状态内容容器
        let statusContent = document.getElementById('status-content');
        if (statusContent.innerText == "Loading...") {
          //statusContent = document.createElement('div');
          //statusContent.id = 'status-content';
          //playerInfoDiv.appendChild(statusContent);
          
          // 初始化内容
          statusContent.innerHTML = `
            <h3 id="player-name-pos">-</h3>
            <p id="player-health">${l.health}: -</p>
            <p id="player-hunger">${l.hunger}: -</p>
            <p id="player-thirst">${l.thirst}: -</p>
            <p id="player-fatigue">${l.fatigue}: -</p>
            <p id="player-attack">${l.attackPower}: -</p>
            <p id="player-intelligence">${l.intelligence}: -</p>
            <p id="player-knowledge">${l.knowledge}: -</p>
            <div id="inventory-section">
              <h4>物品列表:</h4>
              <div id="inventory-list"></div>
            </div>
          `;
        }
        // 确保建造和制造按钮存在
        let craftBtn = document.getElementById('craft-btn');
        let buildBtn = document.getElementById('build-btn');
        
        if (!craftBtn) {
          craftBtn = document.createElement('button');
          craftBtn.id = 'craft-btn';
          craftBtn.textContent = '制造';
          craftBtn.onclick = showCraftOptions;
          statusContent.appendChild(craftBtn);
        }
        
        if (!buildBtn) {
          buildBtn = document.createElement('button');
          buildBtn.id = 'build-btn';
          buildBtn.textContent = '建造';
          buildBtn.onclick = showBuildOptions;
          statusContent.appendChild(buildBtn);
        }
        
        // 根据语言设置更新按钮文本
        craftBtn.textContent = lang === 'zh' ? '制造' : 'Craft';
        buildBtn.textContent = lang === 'zh' ? '建造' : 'Build';
        
        // 更新基本状态数值
        document.getElementById('player-name-pos').textContent = `${name} (${x}, ${y})`;
        document.getElementById('player-health').textContent = `${l.health}: ${health}/${maxHealth}`;
        document.getElementById('player-hunger').textContent = `${l.hunger}: ${hunger.toFixed(1)}`;
        document.getElementById('player-thirst').textContent = `${l.thirst}: ${thirst.toFixed(1)}`;
        document.getElementById('player-fatigue').textContent = `${l.fatigue}: ${fatigue.toFixed(1)}`;
        document.getElementById('player-attack').textContent = `${l.attackPower}: ${attackPower.toFixed(1)}`;
        document.getElementById('player-intelligence').textContent = `${l.intelligence}: ${(intelligence * 100).toFixed(1)}%`;
        document.getElementById('player-knowledge').textContent = `${l.knowledge}: ${Array.isArray(knownKnowledges) ? knownKnowledges.join(', ') : 'None'}`;
        
        // 更新物品列表
        const inventoryList = document.getElementById('inventory-list');
        if (inventoryList) {
          // 检查物品是否发生了变化
          const currentInventory = Array.isArray(window.lastInventory) ? window.lastInventory : [];
          const newInventory = Array.isArray(inventory) ? inventory : [];
          
          const hasChanges = currentInventory.length !== newInventory.length || 
            currentInventory.some((item, index) => 
              item.name !== newInventory[index]?.name || 
              item.type !== newInventory[index]?.type || 
              item.effectValue !== newInventory[index]?.effectValue ||
              item.stackSize !== newInventory[index]?.stackSize
            );
          
          // 仅在物品发生变化时才更新列表
          if (hasChanges) {
            inventoryList.innerHTML = ''; // 清空现有列表
            
            if (newInventory.length > 0) {
              newInventory.forEach((item, index) => {
                const li = document.createElement('p');
                li.innerHTML = `${item.name || item} [${item.stackSize}] <button class="drop-btn" onclick="dropItem(${index})">${l.drop}</button>`;
                inventoryList.appendChild(li);
              });
            } else {
              const li = document.createElement('p');
              li.textContent = '背包为空';
              inventoryList.appendChild(li);
            }
            
            window.lastInventory = newInventory; // 保存当前库存用于下次比较
          }
        }
      }
    }
    
    // 丢弃物品函数
    function dropItem(index) {
      // 通过postMessage发送消息给游戏场景
      if (window.game) {
        const gameScene = window.game.scene.getScene('GameScene');
        if (gameScene && gameScene.player) {
          // 直接调用玩家的dropItem方法
          gameScene.player.dropItem(index, gameScene.world);
        }
      } else {
        // 如果游戏实例还未初始化，通过postMessage通知
        window.parent.postMessage({
          type: 'DROP_ITEM',
          index: index
        }, '*');
      }
    }
    
    // 显示幸存者日志
    function showSurvivorLogs(name, logs) {
      const logsTitle = document.getElementById('logs-title');
      const logsList = document.getElementById('logs-list');
      
      if (logsTitle && logsList) {
        logsTitle.innerHTML = `${name} 的日志`;
        
        // 确保logs是数组，如果不是则尝试解析
        let logsArray = logs;
        if (!Array.isArray(logs)) {
          try {
            logsArray = JSON.parse(logs);
          } catch(e) {
            console.error("Failed to parse logs:", e);
            logsArray = [];
          }
        }
        
        // 生成日志列表HTML
        const logsHtml = logsArray.map(log => `<div>${log}</div>`).join('');
        logsList.innerHTML = logsHtml || '<div>暂无日志</div>';
        
        logsPanel.style.display = 'block';
      }
    }
    
    // 关闭日志面板
    function closeLogsPanel() {
      logsPanel.style.display = 'none';
    }
    
    // 跳转到幸存者位置
    function jumpToSurvivor(x, y) {
      window.jumpToPosition(x, y);
    }
    
    // 跳转到指定位置
    window.jumpToPosition = function(x, y) {
      // 发送消息到Phaser游戏实例
      window.parent.postMessage({
        type: 'JUMP_TO_POSITION',
        x: x,
        y: y
      }, '*');
      console.log("Jump to position:", x, y);
      centerCameraOnPerson('', x, y);
    };
    
    // 跳转到幸存者位置
    window.jumpToSurvivor = function(x, y) {
      window.jumpToPosition(x, y);
    };
    
    // 显示/隐藏幸存者面板
    window.toggleSurvivorsPanel = function() {
      const isVisible = survivorsPanel.style.display !== 'none';
      survivorsPanel.style.display = isVisible ? 'none' : 'block';
      toggleSurvivorsBtn.textContent = isVisible ? '显示幸存者' : '隐藏幸存者';
    };
    
    // 切换怪物面板显示/隐藏
    window.toggleMonstersPanel = function() {
      const isVisible = monstersPanel.style.display !== 'none';
      monstersPanel.style.display = isVisible ? 'none' : 'block';
      toggleMonstersBtn.textContent = isVisible ? '显示怪物' : '隐藏怪物';
    };

    
    // 添加事件到日志
    function addEventToLog(event) {
      if (eventLog) {
        eventLog.innerHTML = eventLog.innerHTML + '<br>' + event;
      }
    }
    
    // 显示悬浮提示
    function showTooltip(text, x, y) {
      if (tooltip) {
        tooltip.innerHTML = text;
        tooltip.style.left = x + 'px';
        tooltip.style.top = y + 'px';
        tooltip.style.visibility = 'visible';
      }
    }
    
    // 隐藏悬浮提示
    function hideTooltip() {
      if (tooltip) {
        tooltip.style.visibility = 'hidden';
      }
    }
    
    // 切换语言
    window.switchLanguage = function() {
      const currentLang = currentLangElement.textContent;
      currentLangElement.textContent = currentLang === 'ZH' ? 'EN' : 'ZH';
    };
    
    // 切换AI配置面板显示/隐藏
    window.toggleAiConfigPanel = function() {
      aiConfigPanel.style.display = aiConfigPanel.style.display === 'block' ? 'none' : 'block';
    };
    
    // 关闭AI配置面板
    window.closeAiConfigPanel = function() {
      aiConfigPanel.style.display = 'none';
    };
    
    // 保存AI配置
    window.saveAiConfig = function() {
      const apiUrl = document.getElementById('api-url').value;
      const apiKey = document.getElementById('api-key').value;
      const modelName = document.getElementById('model-name').value;
      
      // 保存到localStorage
      localStorage.setItem('aiApiUrl', apiUrl);
      localStorage.setItem('aiApiKey', apiKey);
      localStorage.setItem('aiModelName', modelName);
      
      alert('AI配置已保存！');
      closeAiConfigPanel();
    };
    
    // 切换Tick速率面板显示/隐藏
    window.toggleTickRatePanel = function() {
      // 从游戏场景获取当前tick速率
      const gameScene = window.game?.scene?.getScene('GameScene');
      if (gameScene && gameScene.ticksPerSecond) {
        document.getElementById('tick-rate').value = gameScene.ticksPerSecond;
      }
      tickRatePanel.style.display = tickRatePanel.style.display === 'block' ? 'none' : 'block';
    };
    
    // 关闭Tick速率面板
    window.closeTickRatePanel = function() {
      tickRatePanel.style.display = 'none';
    };
    
    // 保存Tick速率设置
    window.saveTickRate = function() {
      const tickRate = parseInt(document.getElementById('tick-rate').value);
      if (isNaN(tickRate) || tickRate < 1 || tickRate > 60) {
        alert('请输入有效的Tick速率 (1-60)');
        return;
      }
      
      // 通知游戏场景更新tick速率
      const gameScene = window.game?.scene?.getScene('GameScene');
      if (gameScene) {
        gameScene.setTicksPerSecond(tickRate);
      }
      
      alert(`Tick速率已设置为 ${tickRate} ticks/s`);
      closeTickRatePanel();
    };
    
    // 显示tooltip
    window.showTooltip = function(content, x, y) {
      if (tooltip) {
        tooltip.innerHTML = content;
        tooltip.style.left = x + 'px';
        tooltip.style.top = y + 'px';
        tooltip.style.visibility = 'visible';
      }
    };
    
    // 隐藏tooltip
    window.hideTooltip = function() {
      if (tooltip) {
        tooltip.style.visibility = 'hidden';
      }
    };
    
    // 添加事件到事件日志
    window.addEventLog = function(event) {
      if (eventLog) {
        const current = eventLog.innerHTML;
        const newEvent = current + '<br/>' + event;
        // 限制日志数量
        const events = newEvent.split('<br/>');
        if (events.length > 10) {
          eventLog.innerHTML = events.slice(-10).join('<br/>');
        } else {
          eventLog.innerHTML = newEvent;
        }
      }
    };

    function addDialogueToUI(speaker, content, x, y) {
      const dialogueEntry = document.createElement('div');
      dialogueEntry.className = 'dialogue-entry';
      
      const speakerSpan = document.createElement('span');
      speakerSpan.className = 'dialogue-speaker';
      speakerSpan.textContent = speaker;
      speakerSpan.onclick = () => centerCameraOnPerson(speaker, x, y);
      
      dialogueEntry.appendChild(speakerSpan);
      dialogueEntry.innerHTML += `: ${content}`;
      
      const dialogueContent = document.getElementById('dialogue-content');
      dialogueContent.appendChild(dialogueEntry);
      
      // 自动滚动到底部
      dialogueContent.scrollTop = dialogueContent.scrollHeight;
    }

    function centerCameraOnPerson(name, x, y) {
      if (window.game) {
        window.game.scene.getScene('GameScene').centerCameraOnPosition(x, y);
      }
    }

    function showTooltip(content, x, y) {
      const tooltip = document.getElementById('tooltip');
      if (tooltip) {
        tooltip.innerHTML = content.replace(/\n/g, '<br>');
        tooltip.style.left = x + 10 + 'px';
        tooltip.style.top = y + 10 + 'px';
        tooltip.style.display = 'block';
        
        // 确保tooltip不会超出屏幕边界
        const tipRect = tooltip.getBoundingClientRect();
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;
        
        let adjustedLeft = x + 10;
        let adjustedTop = y + 10;
        
        if (x + 10 + tipRect.width > windowWidth) {
          adjustedLeft = windowWidth - tipRect.width - 10;
        }
        
        if (y + 10 + tipRect.height > windowHeight) {
          adjustedTop = y - tipRect.height - 10;
        }
        
        tooltip.style.left = adjustedLeft + 'px';
        tooltip.style.top = adjustedTop + 'px';
      }
    }

    // 鼠标移动时更新tooltip位置
    document.addEventListener('mousemove', (e) => {
      const tooltip = document.getElementById('tooltip');
      if (tooltip && tooltip.style.display !== 'none') {
        tooltip.style.left = e.clientX + 10 + 'px';
        tooltip.style.top = e.clientY + 10 + 'px';
        
        // 确保tooltip不超出窗口边界
        const tipRect = tooltip.getBoundingClientRect();
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;
        
        let adjustedLeft = e.clientX + 10;
        let adjustedTop = e.clientY + 10;
        
        if (e.clientX + tipRect.width > windowWidth) {
          adjustedLeft = windowWidth - tipRect.width - 10;
        }
        
        if (e.clientY + tipRect.height > windowHeight) {
          adjustedTop = e.clientY - tipRect.height - 10;
        }
        
        tooltip.style.left = adjustedLeft + 'px';
        tooltip.style.top = adjustedTop + 'px';
      }
    });

    // 鼠标离开游戏容器时隐藏tooltip
    document.getElementById('game-container').addEventListener('mouseleave', () => {
      const tooltip = document.getElementById('tooltip');
      if (tooltip) {
        tooltip.style.display = 'none';
      }
    });

    // 添加按钮事件监听器
    document.addEventListener('DOMContentLoaded', () => {
      // 日志面板切换按钮
      const logsToggleBtn = document.createElement('button');
      logsToggleBtn.id = 'toggle-logs-btn';
      logsToggleBtn.textContent = 'Hide Logs';
      logsToggleBtn.onclick = window.toggleLogsPanel;
      
      const eventLog = document.getElementById('event-log');
      if (eventLog) {
        eventLog.appendChild(logsToggleBtn);
      }
      
      // 清除日志按钮
      const clearLogsBtn = document.getElementById('clear-logs-btn');
      if (clearLogsBtn) {
        clearLogsBtn.onclick = window.clearLogs;
      }
      
      // 对话面板切换按钮
      const dialogueToggleBtn = document.getElementById('toggle-dialogue-btn');
      if (dialogueToggleBtn) {
        dialogueToggleBtn.onclick = () => {
          const dialogueLog = document.getElementById('dialogue-log');
          if (dialogueLog) {
            dialogueLog.classList.toggle('hidden');
            dialogueToggleBtn.textContent = dialogueLog.classList.contains('hidden') ? 'Show Dialogues' : 'Hide Dialogues';
          }
        };
      }
      
      // 幸存者详情面板切换按钮
      const survivorToggleBtn = document.getElementById('toggle-survivor-btn');
      if (survivorToggleBtn) {
        survivorToggleBtn.onclick = () => {
          const survivorDetails = document.getElementById('survivor-details');
          if (survivorDetails) {
            survivorDetails.classList.toggle('hidden');
            survivorToggleBtn.textContent = survivorDetails.classList.contains('hidden') ? 'Show Details' : 'Hide Details';
          }
        };
      }
      
      // 添加聊天功能
      const chatInput = document.getElementById('chat-input');
      if (chatInput) {
        chatInput.addEventListener('input', (e) => {
        });
        chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            const target = document.getElementById('chat-target').textContent;
            if (target && target !== 'None') {
              const message = chatInput.value.trim();
              if (message) {
                // 添加用户消息到聊天框
                const chatMessages = document.getElementById('chat-messages');
                const userMessage = document.createElement('div');
                userMessage.textContent = `You: ${message}`;
                userMessage.style.marginBottom = '5px';
                chatMessages.appendChild(userMessage);
                
                // 发送消息给AI
                if (window.game) {
                  window.game.scene.getScene('GameScene').processChatMessage(target, message);
                }
                
                chatInput.value = '';
                chatMessages.scrollTop = chatMessages.scrollHeight;
              }
            }
          }
          e.stopPropagation();
        });
      }
      
      // AI配置窗口相关事件
      const openAiConfigBtn = document.getElementById('open-ai-config');
      const aiConfigWindow = document.getElementById('ai-config');
      const closeAiConfigBtn = document.getElementById('close-ai-config');
      const saveAiConfigBtn = document.getElementById('save-ai-config');
      
      if (openAiConfigBtn) {
        openAiConfigBtn.onclick = () => {
          aiConfigWindow.style.display = 'block';
          
          // 加载现有配置
          const config = JSON.parse(localStorage.getItem('aiConfig') || '{}');
          if (config.apiUrl) {
            document.getElementById('api-url').value = config.apiUrl;
          }
          if (config.apiKey) {
            document.getElementById('api-key').value = config.apiKey;
          }
        };
      }
      
      if (closeAiConfigBtn) {
        closeAiConfigBtn.onclick = () => {
          aiConfigWindow.style.display = 'none';
        };
      }
      
      if (saveAiConfigBtn) {
        saveAiConfigBtn.onclick = () => {
          const apiUrl = document.getElementById('api-url').value;
          const apiKey = document.getElementById('api-key').value;
          const apiModel = document.getElementById('api-model').value;
          
          if (apiUrl && apiKey && apiModel) {
            const config = { apiUrl, apiKey, apiModel};
            localStorage.setItem('aiConfig', JSON.stringify(config));
            alert('AI配置已保存！');
            aiConfigWindow.style.display = 'none';
          } else {
            alert('请填写完整的API配置信息！');
          }
        };
      }
    });
    
    // 显示聊天界面的函数
    function showChatInterface(targetName) {
      const chatInterface = document.getElementById('chat-interface');
      const chatTarget = document.getElementById('chat-target');
      
      if (chatInterface && chatTarget) {
        chatTarget.textContent = targetName;
        chatInterface.style.display = 'block';
      }
    }
    
    // 隐藏聊天界面的函数
    function hideChatInterface() {
      const chatInterface = document.getElementById('chat-interface');
      if (chatInterface) {
        chatInterface.style.display = 'none';
      }
    }
    
    // 添加消息到聊天界面
    function addMessageToChat(sender, message) {
      const chatMessages = document.getElementById('chat-messages');
      if (chatMessages) {
        const msgElement = document.createElement('div');
        msgElement.textContent = `${sender}: ${message}`;
        msgElement.style.marginBottom = '5px';
        chatMessages.appendChild(msgElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
      }
    }
    
    // 显示制造选项的函数
    function showCraftOptions() {
      // 创建模态窗口
      let modal = document.getElementById('craft-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'craft-modal';
        modal.style.cssText = `
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.6);
          display: flex;
          justify-content: center;
          align-items: center;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background-color: #2c2c2c;
          margin: auto;
          padding: 20px;
          border: 1px solid #555;
          border-radius: 5px;
          width: 60%;
          max-height: 80%;
          overflow-y: auto;
        `;
        
        const modalHeader = document.createElement('div');
        modalHeader.style.cssText = `
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 15px;
        `;
        
        const title = document.createElement('h3');
        title.textContent = '制造选项';
        
        const closeBtn = document.createElement('span');
        closeBtn.innerHTML = '&times;';
        closeBtn.style.cssText = `
          color: #aaa;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
        `;
        closeBtn.onclick = () => {
          modal.style.display = 'none';
        };
        
        modalHeader.appendChild(title);
        modalHeader.appendChild(closeBtn);
        
        const craftOptions = document.createElement('div');
        craftOptions.id = 'craft-options';
        craftOptions.style.cssText = `
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
          gap: 10px;
        `;
        
        // 定义可制造的物品
        const craftableItems = [
          { name: '木剑', definitionId:'木剑', type: 'weapon', materials: { wood: 5 }, description: '基础近战武器' },
          { name: '石斧', definitionId:'石斧', type: 'weapon', materials: { wood: 3, stone: 2 }, description: '砍伐木材的工具' },
          { name: '石镐', definitionId:'石镐', type: 'weapon', materials: { wood: 3, stone: 3 }, description: '挖掘矿石的工具' },
          { name: '木盾', definitionId:'木盾', type: 'defense', materials: { wood: 8 }, description: '提供基础防护' },
          { name: '布甲', definitionId:'布甲', type: 'defense', materials: { cloth: 10 }, description: '轻便的防护装备' },
          { name: '石墙', definitionId:'石墙', type: 'building_material', materials: { stone: 5 }, description: '用于建造防御工事' },
          { name: '木床', definitionId:'木床', type: 'building_material', materials: { wood: 10, cloth: 5 }, description: '休息设施' },
          { name: '食物', definitionId:'食物', type: 'food', materials: { berry: 3 }, description: '恢复饥饿值' }
        ];
        if (window.game) {
          craftableItems = window.game.scene.getScene('GameScene').getCraftableItems();
        }
        
        craftableItems.forEach(item => {
          const itemElement = document.createElement('div');
          itemElement.className = 'craft-item';
          itemElement.style.cssText = `
            padding: 10px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #3c3c3c;
            cursor: pointer;
          `;
          
          itemElement.innerHTML = `
            <strong>${item.name}</strong><br>
            <small>${item.description}</small><br>
            <small>需要材料: ${Object.entries(item.materials).map(([mat, amt]) => `${mat}:${amt}`).join(', ')}</small>
          `;
          
          itemElement.onclick = () => {
            // 这里需要调用游戏逻辑来处理制造
            if (window.game) {
              
              window.game.scene.getScene('GameScene').attemptCraft(item);
            }
            alert(`正在尝试制造: ${item.name}`);
          };
          
          craftOptions.appendChild(itemElement);
        });
        
        modalContent.appendChild(modalHeader);
        modalContent.appendChild(craftOptions);
        modal.appendChild(modalContent);
        
        document.body.appendChild(modal);
      }
      
      modal.style.display = 'flex';
    }
    
    // 显示建造选项的函数
    function showBuildOptions() {
      // 创建模态窗口
      let modal = document.getElementById('build-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'build-modal';
        modal.style.cssText = `
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.6);
          display: flex;
          justify-content: center;
          align-items: center;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background-color: #2c2c2c;
          margin: auto;
          padding: 20px;
          border: 1px solid #555;
          border-radius: 5px;
          width: 60%;
          max-height: 80%;
          overflow-y: auto;
        `;
        
        const modalHeader = document.createElement('div');
        modalHeader.style.cssText = `
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 15px;
        `;
        
        const title = document.createElement('h3');
        title.textContent = '建造选项';
        
        const closeBtn = document.createElement('span');
        closeBtn.innerHTML = '&times;';
        closeBtn.style.cssText = `
          color: #aaa;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
        `;
        closeBtn.onclick = () => {
          modal.style.display = 'none';
        };
        
        modalHeader.appendChild(title);
        modalHeader.appendChild(closeBtn);
        
        const buildOptions = document.createElement('div');
        buildOptions.id = 'build-options';
        buildOptions.style.cssText = `
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
          gap: 10px;
        `;
        
        // 定义可建造的建筑
        let buildableStructures = [
          //{ name: '房屋', definitionId:'房屋', type: 'shelter', materials: { wood: 20, stone: 10 }, description: '提供庇护所' },
          //{ name: '工作台',definitionId:'工作台', type: 'workbench', materials: { wood: 15 }, description: '制作高级物品的地方' },
          { name: '农田', definitionId:'农田', materials: { wood: 5, stone: 5 }, description: '种植食物' },
          { name: '围墙', definitionId:'围墙', materials: { stone: 10 }, description: '保护区域' },
          //{ name: '仓库', definitionId:'仓库',type: 'storage', materials: { wood: 30, stone: 20 }, description: '储存物品' },
          //{ name: '防御塔',definitionId:'防御塔', type: 'defense', materials: { wood: 25, stone: 15 }, description: '自动防御怪物' },
          
          //{ name: '门', definitionId:'门',type: 'door', materials: { wood: 8 }, description: '可通行的屏障' },
          //{ name: '床', definitionId:'床', type: 'bed', materials: { wood: 10, cloth: 5 }, description: '休息恢复体力' }
        ];
        if (window.game) {
          buildableStructures = window.game.scene.getScene('GameScene').getBuildableStructures();
        }
        
        buildableStructures.forEach(building => {
          const buildingElement = document.createElement('div');
          buildingElement.className = 'build-item';
          buildingElement.style.cssText = `
            padding: 10px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #3c3c3c;
            cursor: pointer;
          `;
          
          buildingElement.innerHTML = `
            <strong>${building.name}</strong><br>
            <small>${building.description}</small><br>
            <small>需要材料: ${Object.entries(building.materials).map(([mat, amt]) => `${mat}:${amt}`).join(', ')}</small>
          `;
          
          buildingElement.onclick = () => {
            // 这里需要调用游戏逻辑来处理建造
            if (window.game) {
              window.game.scene.getScene('GameScene').attemptBuild(building);
            }
            alert(`正在尝试建造: ${building.name}`);
          };
          
          buildOptions.appendChild(buildingElement);
        });
        
        modalContent.appendChild(modalHeader);
        modalContent.appendChild(buildOptions);
        modal.appendChild(modalContent);
        
        document.body.appendChild(modal);
      }
      
      modal.style.display = 'flex';
    }</script></body></html>